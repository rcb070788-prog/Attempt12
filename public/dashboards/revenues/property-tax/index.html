<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Property Tax Receivables — Moore County</title>
  <!-- Professional Plotly Engine -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    :root {
      --bg: #0b0d12;
      --panel: #111522;
      --muted: #8ea0b5;
      --text: #e7eef8;
      --line: #24324a;
      --accent: #4aa3ff;
      --danger: #ff5a6a;
      --ok: #44d17a;
      --chip: #1b2740;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      overflow-x: hidden;
    }
    
    /* Forced Landscape Logic */
    @media screen and (orientation: portrait) and (max-width: 768px) {
      body { overflow: hidden; background: #000; }
      .wrap {
        position: fixed; top: 0; left: 0; width: 100vh; height: 100vw;
        transform: rotate(90deg); transform-origin: top left;
        margin-left: 100vw; overflow-y: auto; padding: 12px;
      }
    }

    .wrap { padding: 14px; width: 100%; min-height: 100vh; display: flex; flex-direction: column; gap: 12px; position: relative; }
    
    /* Mobile Drawer System */
    #drawerContainer {
      position: fixed;
      top: -150px; /* Hidden by default */
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 600px;
      z-index: 1000;
      transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    #drawerContainer.open {
      top: 10px;
    }

    #slidingToolbox { 
      background: var(--panel);
      border: 2px solid var(--accent);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    /* Peaking Settings Tab */
    .drawer-tab {
      position: absolute;
      bottom: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--accent);
      color: #000;
      padding: 6px 20px;
      border-radius: 0 0 12px 12px;
      font-weight: 800;
      font-size: 11px;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      white-space: nowrap;
    }

    /* Desktop View adjustments */
    @media (min-width: 769px) {
      #drawerContainer {
        position: static;
        top: auto;
        left: auto;
        transform: none;
        width: 100%;
        max-width: none;
        margin-bottom: 12px;
      }
      .drawer-tab { display: none; }
      #slidingToolbox { border: 1px solid var(--line); }
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    label { font-size: 11px; font-weight: 800; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block; }
    
    select, button { font: inherit; cursor: pointer; }
    select {
      background: #0f1422; color: var(--text); border: 1px solid var(--line);
      border-radius: 12px; padding: 10px; min-width: 200px; outline: none;
    }
    button {
      background: #0f1422; color: var(--text); border: 1px solid var(--line);
      border-radius: 10px; padding: 8px 14px; font-weight: bold; transition: all 0.2s;
    }
    button:hover { background: var(--line); }
    
    .chip {
      display: inline-flex; gap: 8px; align-items: center; background: var(--chip);
      border: 1px solid var(--line); border-radius: 999px; padding: 6px 12px;
      font-size: 12px; color: var(--muted); cursor: pointer; transition: all 0.2s;
    }
    .chip:hover { border-color: var(--accent); }
    .chip input { cursor: pointer; }
    .chip b { color: var(--text); font-weight: 600; }

    .chartWrap {
      flex-grow: 1; min-height: 450px; border-radius: 16px;
      border: 1px solid var(--line); background: #0d1220; display: flex; flex-direction: column;
    }
    .chartHeader {
      padding: 12px 16px; border-bottom: 1px solid var(--line);
      display: flex; justify-content: space-between; align-items: center;
    }
    .chartTitle { font-size: 16px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
    
    #chart { flex-grow: 1; width: 100%; border-radius: 0 0 16px 16px; }
    
    .footer { margin-top: auto; padding: 10px 4px; font-size: 11px; color: var(--muted); line-height: 1.4; }
  </style>
</head>
<body>

<div class="wrap">
  <!-- Settings Drawer Container -->
  <div id="drawerContainer">
    <div id="slidingToolbox">
      <div class="row" style="justify-content: space-between;">
        <div>
          <label>Data Series</label>
          <select id="seriesSelect">
            <option value="TOT">Total Property Tax Receivables</option>
            <option value="GA">Governmental Activities</option>
            <option value="SCH">Metropolitan School Department</option>
          </select>
        </div>
        <div class="row">
          <label class="chip"><input id="trendToggle" type="checkbox" /><b>Trend</b></label>
          <label class="chip"><input id="inflationToggle" type="checkbox" /><b>Inflation</b></label>
          <label class="chip"><input id="inflationPopToggle" type="checkbox" /><b>+ Pop</b></label>
          <button id="closeReportBtn" style="background:var(--danger); border-color:transparent; color:white; font-size:10px;">CLOSE</button>
        </div>
      </div>
    </div>
    <!-- The Peaking Tab -->
    <div class="drawer-tab" onclick="toggleDrawer()">Settings ▾</div>
  </div>

  <!-- Chart Main Area -->
  <div class="chartWrap">
    <div class="chartHeader">
      <div class="chartTitle">Property Tax Receivables</div>
      <div style="font-size: 10px; font-weight: bold; color: var(--accent); text-transform: uppercase;">
        Tap points for Audit
      </div>
    </div>
    <div id="chart"></div>
  </div>

  <div class="footer">
    Data source: Moore County Annual Financial Reports. Inflation baseline: 2005.
  </div>
</div>

<script>
  // Drawer Toggle Logic
  function toggleDrawer() {
    const container = document.getElementById('drawerContainer');
    const tab = document.querySelector('.drawer-tab');
    container.classList.toggle('open');
    tab.innerHTML = container.classList.contains('open') ? 'Close ▴' : 'Settings ▾';
  }

  // --- CORE DATA ---
  const YEARS = ["05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24"];
  const SERIES_DATA = {
    GA:  [1371586, 1671548, 1809130, 2017383, 2215489, 2166238, 2414025, 2563609, 2579444, 2689082, 2765779, 3419019, 3605713, 3599182, 4005402, 4116389, 4130748, 4436952, 4631424, 4967555],
    SCH: [1662914, 1477914, 1733929, 1928120, 1964456, 2057678, 2114469, 2238670, 2494376, 2581810, 2648380, 2795663, 2933823, 3060644, 3106093, 3190082, 3236252, 3321132, 3315181, 3553915],
    TOT: [3034500, 3149462, 3543059, 3945503, 4179945, 4223916, 4528494, 4802279, 5073820, 5270892, 5414159, 6214682, 6539536, 6659826, 7111495, 7306471, 7367000, 7758084, 7946605, 8521470]
  };
  const URLS = ["https://drive.google.com/file/d/1iYFseTXjfTBOXALpMs_-MbxeZVlPPI6z/view", "https://drive.google.com/file/d/1k_8KkQZKyK9-VtEZfMh7KLTqbAnEosof/view", "https://drive.google.com/file/d/1E2VjD3G9iKbohfQAmBd46pbwujZtQSEs/view", "https://drive.google.com/file/d/1YacNN8_nM2dynCoiGeTpnzPWYdoWw4c9/view", "https://drive.google.com/file/d/1jPJAeskk09tghycpunT62DLR-y_c38lJ/view", "https://drive.google.com/file/d/1jX_wf84UhEf5DBErLpbyrS6A4CFeyqgZ/view", "https://drive.google.com/file/d/1v0H3gtW-fvyND9zAlNKqQ-uS3Ph6DpEl/view", "https://drive.google.com/file/d/1O-vQUCvI2e4HHihfM_ZlWu_3hfjVRuZb/view", "https://drive.google.com/file/d/14s2bNtaiRLHVhNmNBf7eXggn0omevY1-/view", "https://drive.google.com/file/d/1vpoXMcTFlaGt1oRoFWiNMJfqwASKDa82/view", "https://drive.google.com/file/d/1RtnvCWh4BGSYCL23L8RT0yccgBNzQj7n/view", "https://drive.google.com/file/d/1kmURBTiB-YgjhAb4g1lElwOgwnCS7ZO-/view", "https://drive.google.com/file/d/1qhQ0w9kcaX3FQCP4PycDc1zI6l9WKeIi/view", "https://drive.google.com/file/d/1k4UFfBcw8Xb50V_O28WTBWfuEV8wO572/view", "https://drive.google.com/file/d/1ToWBZC2lNNlrbytu135qWpwzKQUWVCaC/view", "https://drive.google.com/file/d/1E13_MsMM2i9JLlZkMgDEFkI6qFXHBlXU/view", "https://drive.google.com/file/d/1rQ2-5cUJkh0aebQCCU1lHaQ7BB5a0352/view", "https://drive.google.com/file/d/1aID2Oksx-Uhvy7feRqTzLszeNQUAxszf/view", "https://drive.google.com/file/d/1fzWWf3L6FRlkefY16jrjiK8QNicHgtax/view", "https://drive.google.com/file/d/1c3EA5wkirG6yiI6xTmm9wEe3KDs7wSEt/view"];
  const CPI_DATA = { 2005: 195.3, 2006: 201.6, 2007: 207.3, 2008: 215.3, 2009: 214.5, 2010: 218.0, 2011: 224.9, 2012: 229.6, 2013: 232.9, 2014: 236.7, 2015: 237.0, 2016: 240.0, 2017: 245.1, 2018: 251.1, 2019: 255.6, 2020: 258.8, 2021: 270.9, 2022: 292.6, 2023: 304.7, 2024: 313.7 };
  const POP_ANCHORS = [ {y: 2000, v: 5740}, {y: 2010, v: 6362}, {y: 2020, v: 6461}, {y: 2025, v: 6800} ];

  function getInterpolatedPop(year) {
    let a, b;
    for (let i=0; i < POP_ANCHORS.length - 1; i++) {
      if (year >= POP_ANCHORS[i].y && year <= POP_ANCHORS[i+1].y) {
        a = POP_ANCHORS[i]; b = POP_ANCHORS[i+1]; break;
      }
    }
    const factor = Math.pow(b.v / a.v, 1 / (b.y - a.y));
    return a.v * Math.pow(factor, year - a.y);
  }

  // --- CHART LOGIC ---
  const state = { series: "TOT", trend: false, inflation: false, pop: false };

  function updateChart() {
    const rawData = SERIES_DATA[state.series];
    const xLabels = YEARS; // Changed from "FY" + y to just y
    
    const traces = [];

    traces.push({
      x: xLabels, y: rawData, name: "Actual",
      mode: 'lines+markers', type: 'scatter',
      line: { color: '#4aa3ff', width: 3 },
      marker: { size: 8, color: '#4aa3ff' },
      customdata: URLS,
      hovertemplate: '<b>FY%{x}</b><br>$%{y:,.0f}<extra></extra>'
    });

    if (state.trend) {
      const n = rawData.length;
      let sumX=0, sumY=0, sumXY=0, sumXX=0;
      for(let i=0; i<n; i++) {
        sumX += i; sumY += rawData[i];
        sumXY += i * rawData[i]; sumXX += i * i;
      }
      const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;
      const trendY = xLabels.map((_, i) => slope * i + intercept);
      traces.push({ x: xLabels, y: trendY, name: "Trend", mode: 'lines', line: { color: '#8ea0b5', dash: 'dash', width: 2 }, hoverinfo: 'skip' });
    }

    if (state.inflation) {
      const baseVal = rawData[0];
      const baseCPI = CPI_DATA[2005];
      const infY = YEARS.map(y => baseVal * (CPI_DATA[2000 + parseInt(y)] / baseCPI));
      traces.push({ x: xLabels, y: infY, name: "Inflation", mode: 'lines', line: { color: '#ffcc66', dash: 'dot', width: 2 }, hovertemplate: 'Infl. Adj: $%{y:,.0f}<extra></extra>' });
    }

    if (state.pop) {
      const baseVal = rawData[0];
      const baseCPI = CPI_DATA[2005];
      const basePop = getInterpolatedPop(2005);
      const popY = YEARS.map(y => {
        const fullYear = 2000 + parseInt(y);
        const infFactor = CPI_DATA[fullYear] / baseCPI;
        const popFactor = getInterpolatedPop(fullYear) / basePop;
        return baseVal * infFactor * popFactor;
      });
      traces.push({ x: xLabels, y: popY, name: "Infl + Pop", mode: 'lines', line: { color: '#44d17a', dash: 'dashdot', width: 2 }, hovertemplate: 'Pop Adj: $%{y:,.0f}<extra></extra>' });
    }

    const layout = {
      paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
      margin: { l: 50, r: 20, t: 20, b: 40 },
      font: { color: '#e7eef8', family: 'system-ui' },
      xaxis: { gridcolor: '#1c2740', linecolor: '#24324a', zeroline: false, tickmode: 'array', tickvals: YEARS },
      yaxis: { gridcolor: '#1c2740', linecolor: '#24324a', tickformat: '$,.0f', zeroline: false },
      legend: { orientation: 'h', x: 0, y: -0.2, font: { size: 10 } },
      hovermode: 'closest'
    };

    Plotly.react('chart', traces, layout, { responsive: true, displaylogo: false });
  }

  // --- INITIALIZATION ---
  document.getElementById("seriesSelect").onchange = (e) => { state.series = e.target.value; updateChart(); };
  document.getElementById("trendToggle").onchange = (e) => { state.trend = e.target.checked; updateChart(); };
  document.getElementById("inflationToggle").onchange = (e) => { state.inflation = e.target.checked; updateChart(); };
  document.getElementById("inflationPopToggle").onchange = (e) => { state.pop = e.target.checked; updateChart(); };
  document.getElementById("closeReportBtn").onclick = () => { if (window.parent) window.parent.postMessage({ type: 'CLOSE_DASHBOARD' }, '*'); };

  document.getElementById('chart').on('plotly_click', (data) => {
    const url = data.points[0].customdata;
    if (url) window.open(url, "_blank");
  });

  updateChart();
</script>

</body>
</html>